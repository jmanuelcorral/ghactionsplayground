---
name: comments recipe on issues

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
# idea from : https://pakstech.com/blog/gh-actions-issue-comments/
jobs:
  comments:
    name: get PR SHA
    runs-on: ubuntu-20.04
    if: ${{ github.event.comment.body == '/deploydb'}}
    steps:
    
    - name: Add Comment
      if: ${{ success() }}
      uses: actions/github-script@v4
      with:
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'You can see this workflow running on: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}',
          });  
    - name: Get PR SHA
      id: sha
      uses: actions/github-script@v4
      with:
        result-encoding: string
        script: |
          const { owner, repo, number } = context.issue;
          const pr = await github.pulls.get({
            owner,
            repo,
            pull_number: number,
          });
          return pr.data.head.sha    

    - uses: actions/checkout@v2
      with:
        ref: ${{ steps.sha.outputs.result }}

    - name: Fail randomly
      run: |
        cat README.md
        exit $((RANDOM % 2))   

    - name: Message success
      if: ${{ success() }}
      uses: actions/github-script@v4
      with:
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Deployment succeeded! ✅',
          });          
    - name: Message failure
      if: ${{ failure() }}
      uses: actions/github-script@v4
      with:
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Deployment failed! ❌',
          });          
